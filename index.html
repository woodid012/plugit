<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <!-- External CSS Files -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/device-cards.css">
    <link rel="stylesheet" href="/assets/css/charts.css">
    <link rel="stylesheet" href="/assets/css/automation.css">
    <link rel="stylesheet" href="/assets/css/modal.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üè† Smart Home Control</h1>
                <p class="subtitle">Control all your smart devices from one place</p>
            </div>
            <div class="header-buttons">
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <!-- Settings Modal -->
        <div id="settingsModal" class="settings-modal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>‚öôÔ∏è Settings</h2>
                    <button class="close-btn" onclick="closeSettings()">&times;</button>
                </div>
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="settings-group">
                        <label for="defaultCostPerKwh">Default Cost per kWh ($)</label>
                        <input type="number" id="defaultCostPerKwh" step="0.01" min="0" required>
                        <div class="input-help">Used for cost calculations in charts</div>
                    </div>
                    <div class="settings-group">
                        <label for="automationDuration">Automation Duration (seconds)</label>
                        <input type="number" id="automationDuration" step="1" min="1" required>
                        <div class="input-help">How long device stays on before turning off</div>
                    </div>
                    <div class="settings-group">
                        <label for="minPowerThreshold">Minimum Power Threshold (W)</label>
                        <input type="number" id="minPowerThreshold" step="0.1" min="0" required>
                        <div class="input-help">Device must exceed this power for duration before turning off</div>
                    </div>
                    <div class="settings-group">
                        <label for="defaultStartTime">Default Start Time</label>
                        <input type="time" id="defaultStartTime" required>
                        <div class="input-help">Default restart time for new automations</div>
                    </div>
                    <div class="settings-group">
                        <label for="region">NEM Region</label>
                        <select id="region" required>
                            <option value="VIC1">VIC1 (Victoria)</option>
                            <option value="NSW1">NSW1 (New South Wales)</option>
                            <option value="QLD1">QLD1 (Queensland)</option>
                            <option value="SA1">SA1 (South Australia)</option>
                            <option value="TAS1">TAS1 (Tasmania)</option>
                        </select>
                        <div class="input-help">Region for power price data</div>
                    </div>
                    <div class="settings-actions">
                        <button type="button" class="cancel-btn" onclick="closeSettings()">Cancel</button>
                        <button type="submit" class="save-btn">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="error-container"></div>
        <div id="loading" class="loading loading-pulse">Loading devices...</div>
        <div id="content" style="display: none;">
            <!-- Power Usage Chart -->
            <div class="chart-container" id="chart-section" style="display: none;">
                <div class="chart-header">
                    <div class="chart-icon">üìä</div>
                    <h2 class="chart-title">Power Usage (30-second intervals)</h2>
                    <button class="export-csv-btn" onclick="exportTimeseriesToCSV()">üì• Export to CSV</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>
            <!-- Cost Chart -->
            <div class="chart-container" id="cost-chart-section" style="display: none;">
                <div class="chart-header">
                    <div class="chart-icon">üí∞</div>
                    <h2 class="chart-title">Estimated Cost (5-minute intervals)</h2>
                    <div class="chart-totals">
                        <div class="daily-total">
                            <span class="total-label">Total Today:</span>
                            <span class="total-value" id="daily-total-value">$0.00</span>
                        </div>
                        <div class="savings-info">
                            <span class="savings-label">Savings (12pm-3pm free):</span>
                            <span class="savings-value" id="savings-value">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
            <!-- Power Price Chart -->
            <div class="chart-container" id="price-chart-section" style="display: none;">
                <div class="chart-header">
                    <div class="chart-icon">‚ö°</div>
                    <h2 class="chart-title">Power Price (5-minute intervals)</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- All Devices in One Grid -->
            <div class="device-group">
                <div class="group-header">
                    <div class="group-icon tapo-icon">üè†</div>
                    <h2 class="group-title">All Devices</h2>
                </div>
                <div class="devices-grid" id="all-devices"></div>
            </div>

            <!-- Automations Section -->
            <div class="device-group">
                <div class="group-header">
                    <div class="group-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚öôÔ∏è</div>
                    <h2 class="group-title">Automations</h2>
                </div>
                <div class="devices-grid" id="automations-grid"></div>
            </div>
        </div>

        <div class="last-updated" id="last-updated"></div>
    </div>

    <!-- External JavaScript Files -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/settings.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/device-control.js"></script>
    <script src="/assets/js/automation.js"></script>
    <script src="/assets/js/timeseries.js"></script>
    <script src="/assets/js/charts.js"></script>
    <script src="/assets/js/main.js"></script>
    <!-- Inline JavaScript removed - using external JS files -->
</body>
</html>
